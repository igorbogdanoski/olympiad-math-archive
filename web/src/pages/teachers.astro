---
import Layout from '../layouts/Layout.astro';
import problems from '../data/problems.json';

// –ï–∫—Å—Ç—Ä–∞–∫—Ü–∏—ò–∞ –Ω–∞ –º–µ—Ç–∞–ø–æ–¥–∞—Ç–æ—Ü–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—Å–∫–∞ —Å—Ç—Ä–∞–Ω–∞
const grades = [...new Set(problems.map(p => p.grade))].filter(g => g !== 'N/A').sort();
const categories = [...new Set(problems.map(p => p.category))].filter(c => c !== 'N/A').sort();
---

<Layout title="–ó–∞ –ù–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏ - –ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –¢–µ—Å—Ç">
	<div class="max-w-5xl mx-auto">
		<div class="mb-10">
			<h1 class="text-4xl font-black mb-4">–ê–ª–∞—Ç–∫–∏ –∑–∞ –ù–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏</h1>
			<p class="text-slate-500 dark:text-slate-400 text-lg">
				–ö—Ä–µ–∏—Ä–∞—ò—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ —Ç–µ—Å—Ç–æ–≤–∏ –∏ —Ä–∞–±–æ—Ç–Ω–∏ –ª–∏—Å—Ç–æ–≤–∏ –∑–∞ –≤–∞—à–∏—Ç–µ —É—á–µ–Ω–∏—Ü–∏ –≤–æ –Ω–µ–∫–æ–ª–∫—É —Å–µ–∫—É–Ω–¥–∏.
			</p>
		</div>

		<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
			<div class="lg:col-span-1 space-y-6">
				<div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm">
					<h3 class="font-bold text-lg mb-6 flex items-center gap-2">
						<span class="text-blue-500">‚öôÔ∏è</span> –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –Ω–∞ —Ç–µ—Å—Ç
					</h3>
					
					<div class="space-y-4">
						<div>
							<label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">–û–¥–¥–µ–ª–µ–Ω–∏–µ</label>
							<select id="test-grade" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
								<option value="">–°–∏—Ç–µ</option>
								{grades.map(g => <option value={g}>{g}-—Ç–æ –æ–¥–¥–µ–ª–µ–Ω–∏–µ</option>)}
							</select>
						</div>

						<div>
							<label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">–û–±–ª–∞—Å—Ç</label>
							<select id="test-cat" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
								<option value="">–°–∏—Ç–µ –æ–±–ª–∞—Å—Ç–∏</option>
								{categories.map(c => <option value={c} class="capitalize">{c}</option>)}
							</select>
						</div>

						<div>
							<label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">–ë—Ä–æ—ò –Ω–∞ –∑–∞–¥–∞—á–∏</label>
							<input type="number" id="test-count" value="5" min="1" max="20" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
						</div>

						<button id="generate-preview" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-500/30 transition-all active:scale-95">
							–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –ø—Ä–µ–≥–ª–µ–¥
						</button>
					</div>
				</div>

                <div class="bg-amber-50 dark:bg-amber-900/10 p-6 rounded-3xl border border-amber-100 dark:border-amber-900/30">
                    <h4 class="font-bold text-amber-800 dark:text-amber-400 mb-2 italic text-sm">–ü—Ä–æ –°–æ–≤–µ—Ç:</h4>
                    <p class="text-xs text-amber-700 dark:text-amber-500 leading-relaxed">
                        –ö–æ—Ä–∏—Å—Ç–µ—Ç–µ –≥–æ –∫–æ–ø—á–µ—Ç–æ –∑–∞ –ø–µ—á–∞—Ç–µ—ö–µ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç—Å–∫–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞—ö–µ –Ω–∞ –ê4 –ª–∏—Å—Ç.
                    </p>
                </div>
			</div>

		<div class="lg:col-span-2">
			<div class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden min-h-[500px] flex flex-col">
				<div class="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
					<h3 class="font-bold">–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ —Ç–µ—Å—Ç</h3>
					<div class="flex gap-2">
						<button id="print-test" class="hidden px-4 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold hover:bg-blue-700 transition-colors">
							üñ®Ô∏è –ü–µ—á–∞—Ç–∏ –¢–µ—Å—Ç
						</button>
					</div>
				</div>
				
				<div id="test-content" class="p-8 flex-grow overflow-y-auto">
					<div class="flex flex-col items-center justify-center h-full text-slate-400 py-20">
						<span class="text-6xl mb-4">üìÑ</span>
						<p>–ò–∑–±–µ—Ä–µ—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∏ –∫–ª–∏–∫–Ω–µ—Ç–µ –Ω–∞ "–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –ø—Ä–µ–≥–ª–µ–¥"</p>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- KaTeX Client Side for Preview -->
	<script is:inline src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
	<script is:inline src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</Layout>

<script>
	// –ß–∏—Å—Ç–∞ –∏ –±–µ–∑–±–µ–¥–Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞ –±–µ–∑ –∏–Ω—ò–µ–∫—Ç–∏—Ä–∞–Ω–∏ –≥–æ–ª–µ–º–∏ JSON –æ–±—ò–µ–∫—Ç–∏
	const genBtn = document.getElementById('generate-preview');
	const testContent = document.getElementById('test-content');
	const printBtn = document.getElementById('print-test');

	genBtn?.addEventListener('click', async () => {
		const grade = (document.getElementById('test-grade') as HTMLSelectElement).value;
		const cat = (document.getElementById('test-cat') as HTMLSelectElement).value;
		const count = parseInt((document.getElementById('test-count') as HTMLInputElement).value);

		genBtn.innerText = '–í—á–∏—Ç—É–≤–∞–º...';
		
		try {
			const res = await fetch('/data/problems.json');
			const problems = await res.json();
			
			let filtered = problems;
			if (grade) filtered = filtered.filter((p: any) => p.grade === grade);
			if (cat) filtered = filtered.filter((p: any) => p.category === cat);
			
			const selected = filtered.sort(() => 0.5 - Math.random()).slice(0, count);
			
			if (selected.length === 0) {
				testContent!.innerHTML = '<p class="text-center text-red-500">–ù–µ–º–∞ –ø—Ä–æ–Ω–∞—ò–¥–µ–Ω–æ –∑–∞–¥–∞—á–∏.</p>';
				return;
			}

			let html = `<div class="p-4 space-y-8">`;
			selected.forEach((p: any, i: number) => {
				html += `<div class="pb-6 border-b border-slate-100">
					<p class="font-black text-blue-600 mb-2">–ó–∞–¥–∞—á–∞ #${i+1}</p>
					<div class="prose max-w-none">${p.body.split('##')[0]}</div>
				</div>`;
			});
			html += `</div>`;
			
			testContent!.innerHTML = html;
			printBtn?.classList.remove('hidden');

			// –†–µ–Ω–¥–µ—Ä–∏—Ä–∞—ò LaTeX
			if (window.renderMathInElement) {
				window.renderMathInElement(testContent, {
					delimiters: [
						{left: '$$', right: '$$', display: true},
						{left: '$', right: '$', display: false}
					],
					throwOnError : false
				});
			}
		} catch (e) {
			console.error(e);
		} finally {
			genBtn.innerText = '–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –ø—Ä–µ–≥–ª–µ–¥';
		}
	});

	printBtn?.addEventListener('click', () => window.print());
</script>
