---
import Layout from '../layouts/Layout.astro';
import problems from '../data/problems.json';

// –ï–∫—Å—Ç—Ä–∞–∫—Ü–∏—ò–∞ –Ω–∞ –º–µ—Ç–∞–ø–æ–¥–∞—Ç–æ—Ü–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—Å–∫–∞ —Å—Ç—Ä–∞–Ω–∞
const grades = [...new Set(problems.map(p => p.grade))].filter(g => g !== 'N/A').sort();
const categories = [...new Set(problems.map(p => p.category))].filter(c => c !== 'N/A').sort();
---

<Layout title="–ó–∞ –ù–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏ - –ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –¢–µ—Å—Ç">
	<div class="max-w-5xl mx-auto">
		<div class="mb-10 no-print">
			<h1 class="text-4xl font-black mb-4">–ê–ª–∞—Ç–∫–∏ –∑–∞ –ù–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏</h1>
			<p class="text-slate-500 dark:text-slate-400 text-lg">
				–ö—Ä–µ–∏—Ä–∞—ò—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ —Ç–µ—Å—Ç–æ–≤–∏ –∏ —Ä–∞–±–æ—Ç–Ω–∏ –ª–∏—Å—Ç–æ–≤–∏ –∑–∞ –≤–∞—à–∏—Ç–µ —É—á–µ–Ω–∏—Ü–∏ –≤–æ –Ω–µ–∫–æ–ª–∫—É —Å–µ–∫—É–Ω–¥–∏.
			</p>
		</div>

		<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
			<div class="lg:col-span-1 space-y-6 no-print">
				<div class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm">
					<h3 class="font-bold text-lg mb-6 flex items-center gap-3">
						<span class="p-2 bg-blue-600 text-white rounded-lg text-sm">
							<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
						</span>
						–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –Ω–∞ —Ç–µ—Å—Ç
					</h3>
					
					<div class="space-y-6">
						<div>
							<label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">–û–¥–¥–µ–ª–µ–Ω–∏–µ</label>
							<select id="test-grade" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3.5 text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none transition-all">
								<option value="">–°–∏—Ç–µ</option>
								{grades.map(g => <option value={g}>{g}-—Ç–æ –æ–¥–¥–µ–ª–µ–Ω–∏–µ</option>)}
							</select>
						</div>

						<div>
							<label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">–û–±–ª–∞—Å—Ç</label>
							<select id="test-cat" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3.5 text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none transition-all">
								<option value="">–°–∏—Ç–µ –æ–±–ª–∞—Å—Ç–∏</option>
								{categories.map(c => <option value={c} class="capitalize">{c}</option>)}
							</select>
						</div>

						<div>
							<label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">–ë—Ä–æ—ò –Ω–∞ –∑–∞–¥–∞—á–∏</label>
							<input type="number" id="test-count" value="5" min="1" max="20" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3.5 text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
						</div>

						<button id="generate-preview" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-500/20 transition-all active:scale-95 flex items-center justify-center gap-2">
							<span>–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –ø—Ä–µ–≥–ª–µ–¥</span>
						</button>
					</div>
				</div>

                <div class="bg-indigo-50/50 dark:bg-indigo-900/10 p-6 rounded-3xl border border-indigo-100 dark:border-indigo-900/30">
                    <h4 class="font-bold text-indigo-900 dark:text-indigo-400 mb-2 italic text-sm">–ü—Ä–æ –°–æ–≤–µ—Ç:</h4>
                    <p class="text-xs text-indigo-700 dark:text-indigo-500 leading-relaxed font-medium">
                        –ö–æ—Ä–∏—Å—Ç–µ—Ç–µ –≥–æ –∫–æ–ø—á–µ—Ç–æ –∑–∞ –ø–µ—á–∞—Ç–µ—ö–µ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç—Å–∫–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞—ö–µ –Ω–∞ –ê4 –ª–∏—Å—Ç. –°–∏—Ç–µ –Ω–∞—Å–ª–æ–≤–∏ –∏ –º–µ–Ω–∏—ò–∞ —ú–µ –±–∏–¥–∞—Ç –∞–≤—Ç–æ–º–∞—Ç—Å–∫–∏ —Å–æ–∫—Ä–∏–µ–Ω–∏.
                    </p>
                </div>
			</div>

		<div class="lg:col-span-2">
			<div class="bg-white dark:bg-slate-900 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden min-h-[600px] flex flex-col transition-all">
				<div class="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/30 no-print">
					<h3 class="font-black text-slate-900 dark:text-white uppercase tracking-tight">–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ —Ç–µ—Å—Ç</h3>
					<div class="flex gap-2">
						<button id="print-test" class="hidden px-6 py-2.5 bg-blue-600 text-white rounded-xl text-xs font-black hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/20 active:scale-95 uppercase tracking-widest">
							üñ®Ô∏è –ü–µ—á–∞—Ç–∏ –¢–µ—Å—Ç
						</button>
					</div>
				</div>
				
				<div id="test-content" class="p-10 flex-grow overflow-y-auto">
					<div class="print-only hidden text-center mb-10 border-b-2 border-black pb-6">
						<h1 class="text-2xl font-black uppercase mb-2">–ú–∞—Ç–µ–º–∞—Ç–∏—á–∫–∏ –¢–µ—Å—Ç</h1>
						<div class="flex justify-between mt-4 font-bold">
							<span>–ò–º–µ –∏ –ø—Ä–µ–∑–∏–º–µ: ______________________</span>
							<span>–î–∞—Ç–∞: __________</span>
						</div>
					</div>
					<div class="flex flex-col items-center justify-center h-full text-slate-400 py-20 no-print">
						<span class="text-7xl mb-6 opacity-20">üìÑ</span>
						<p class="font-bold uppercase tracking-widest text-xs">–ò–∑–±–µ—Ä–µ—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∏ –∫–ª–∏–∫–Ω–µ—Ç–µ –Ω–∞ "–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –ø—Ä–µ–≥–ª–µ–¥"</p>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- KaTeX Client Side for Preview -->
	<script is:inline src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
	<script is:inline src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</Layout>

<script>
	// –ß–∏—Å—Ç–∞ –∏ –±–µ–∑–±–µ–¥–Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞ –±–µ–∑ –∏–Ω—ò–µ–∫—Ç–∏—Ä–∞–Ω–∏ –≥–æ–ª–µ–º–∏ JSON –æ–±—ò–µ–∫—Ç–∏
	const genBtn = document.getElementById('generate-preview');
	const testContent = document.getElementById('test-content');
	const printBtn = document.getElementById('print-test');

	genBtn?.addEventListener('click', async () => {
		const grade = (document.getElementById('test-grade') as HTMLSelectElement).value;
		const cat = (document.getElementById('test-cat') as HTMLSelectElement).value;
		const count = parseInt((document.getElementById('test-count') as HTMLInputElement).value);

		genBtn.innerText = '–í—á–∏—Ç—É–≤–∞–º...';
		
		try {
			const res = await fetch('/data/problems.json');
			const problems = await res.json();
			
			let filtered = problems;
			if (grade) filtered = filtered.filter((p: any) => p.grade === grade);
			if (cat) filtered = filtered.filter((p: any) => p.category === cat);
			
			const selected = filtered.sort(() => 0.5 - Math.random()).slice(0, count);
			
			if (selected.length === 0) {
				testContent!.innerHTML = '<p class="text-center text-red-500">–ù–µ–º–∞ –ø—Ä–æ–Ω–∞—ò–¥–µ–Ω–æ –∑–∞–¥–∞—á–∏.</p>';
				return;
			}

			let html = `<div class="space-y-12">`;
			selected.forEach((p: any, i: number) => {
				html += `<div class="break-inside-avoid pb-8 border-b border-slate-100 dark:border-slate-800 last:border-0">
					<p class="font-black text-blue-600 mb-4 uppercase tracking-widest text-[10px] no-print">–ó–∞–¥–∞—á–∞ #${i+1}</p>
					<p class="hidden print:block font-bold mb-4 text-lg">–ó–∞–¥–∞—á–∞ ${i+1}.</p>
					<div class="prose dark:prose-invert max-w-none text-slate-800 dark:text-slate-200">${p.body.split('##')[0]}</div>
				</div>`;
			});
			html += `</div>`;
			
			testContent!.innerHTML = html;
			printBtn?.classList.remove('hidden');

			// –†–µ–Ω–¥–µ—Ä–∏—Ä–∞—ò LaTeX
			if (window.renderMathInElement) {
				window.renderMathInElement(testContent, {
					delimiters: [
						{left: '$$', right: '$$', display: true},
						{left: '$', right: '$', display: false}
					],
					throwOnError : false
				});
			}
		} catch (e) {
			console.error(e);
		} finally {
			genBtn.innerText = '–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –ø—Ä–µ–≥–ª–µ–¥';
		}
	});

	printBtn?.addEventListener('click', () => window.print());
</script>
