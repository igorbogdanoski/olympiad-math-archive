---
import Layout from '../../layouts/Layout.astro';
import problems from '../../../tools/problems.json';

export async function getStaticPaths() {
  return problems.map((prob) => ({
    params: { id: prob.meta.problem_id || prob.filename.replace('.md', '') },
    props: { prob },
  }));
}

const { prob } = Astro.props;
const { meta, body, filename, grade, category, difficulty } = prob;

// –ü–æ–¥–µ–ª–±–∞ –Ω–∞ –ø—Ä–∞—à–∞—ö–µ –∏ —Ä–µ—à–µ–Ω–∏–µ
const parts = body.split(/##\s+.*–†–µ—à–µ–Ω–∏–µ/i);
const question = parts[0];
const solution = parts.length > 1 ? parts[1] : null;
---

<Layout title={`${filename.replace('.md', '').replace(/_/g, ' ')} - –ú–∞—Ç–ê—Ä—Ö–∏–≤–∞`}>
  <div class="max-w-4xl mx-auto">
    <nav class="flex mb-8 text-sm text-slate-500 gap-2 items-center">
      <a href="/" class="hover:text-blue-600">–ü–æ—á–µ—Ç–Ω–∞</a>
      <span>/</span>
      <span class="capitalize">{category}</span>
      <span>/</span>
      <span class="text-slate-900 font-medium">{filename.replace('.md', '')}</span>
    </nav>

    <article class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
      {/* Header —Å–µ–∫—Ü–∏—ò–∞ */}
      <div class="p-8 border-b border-slate-100 bg-slate-50/50">
        <div class="flex flex-wrap gap-3 mb-4">
          <span class="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-bold rounded-full">–û–¥–¥–µ–ª–µ–Ω–∏–µ: {grade}</span>
          <span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-sm font-bold rounded-full uppercase">{category}</span>
          <span class="px-3 py-1 bg-amber-100 text-amber-700 text-sm font-bold rounded-full">–¢–µ–∂–∏–Ω–∞: {difficulty}/10</span>
        </div>
        <h1 class="text-3xl font-extrabold text-slate-900">
          {filename.replace('.md', '').replace(/_/g, ' ')}
        </h1>
      </div>

      <div class="p-8">
        {/* –í–∏–∑—É–µ–ª–∏–∑–∞—Ü–∏—ò–∞ */}
        {meta.problem_id && (
          <div class="mb-10 rounded-2xl border border-slate-100 bg-white p-4 shadow-inner">
             <img 
                src={`/assets/images/${meta.problem_id}/${meta.problem_id}.png`} 
                alt="–í–∏–∑—É–µ–ª–∏–∑–∞—Ü–∏—ò–∞ –Ω–∞ –∑–∞–¥–∞—á–∞—Ç–∞"
                class="w-full h-auto rounded-lg mx-auto max-h-[500px] object-contain"
                onerror="this.style.display='none'"
              />
          </div>
        )}

        {/* –¢–µ–∫—Å—Ç –Ω–∞ –∑–∞–¥–∞—á–∞—Ç–∞ */}
        <div class="prose prose-slate prose-lg max-w-none mb-12">
          <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-blue-500">üìù</span> –¢–µ–∫—Å—Ç –Ω–∞ –∑–∞–¥–∞—á–∞—Ç–∞
          </h2>
          <div class="content-math">
            {question}
          </div>
        </div>

        {/* –†–µ—à–µ–Ω–∏–µ */}
        {solution && (
          <div class="mt-8 border-t border-slate-100 pt-8">
            <details class="group bg-slate-50 rounded-2xl p-6 open:bg-white open:shadow-sm transition-all border border-transparent open:border-slate-200">
              <summary class="list-none cursor-pointer flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                  <span class="text-emerald-500">üí°</span> –†–µ—à–µ–Ω–∏–µ
                </h3>
                <span class="text-slate-400 group-open:rotate-180 transition-transform">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="Wait 19 9l-7 7-7-7" />
                  </svg>
                </span>
              </summary>
              <div class="mt-6 prose prose-emerald prose-lg max-w-none content-math">
                {solution}
              </div>
            </details>
          </div>
        )}
      </div>
    </article>

    {/* Footer –∏–Ω—Ñ–æ */}
    <div class="mt-8 p-6 bg-blue-50 rounded-2xl text-blue-800 text-sm">
      <p><strong>–ò–∑–≤–æ—Ä:</strong> {meta.source || '–ê—Ä—Ö–∏–≤–∞ –Ω–∞ Geo-Mentor'}</p>
      {meta.tags && meta.tags.length > 0 && (
        <div class="mt-2 flex gap-2 flex-wrap">
          <strong>–¢–∞–≥–æ–≤–∏:</strong>
          {meta.tags.map(tag => (
            <span class="bg-blue-100 px-2 py-0.5 rounded text-blue-600">#{tag}</span>
          ))}
        </div>
      )}
    </div>
  </div>
</Layout>

<script>
  // –°–∫—Ä–∏–ø—Ç–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç—Å–∫–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ä–∞—ö–µ –Ω–∞ KaTeX
  import renderMathInElement from 'katex/dist/contrib/auto-render.js';
  
  document.addEventListener('DOMContentLoaded', () => {
    const elements = document.querySelectorAll('.content-math');
    elements.forEach(el => {
      renderMathInElement(el, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError : false
      });
    });
  });
</script>
