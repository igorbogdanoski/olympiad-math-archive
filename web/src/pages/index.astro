---
import Layout from '../layouts/Layout.astro';
import problems from '../data/problems.json';

// –ï–∫—Å—Ç—Ä–∞–∫—Ü–∏—ò–∞ –Ω–∞ —É–Ω–∏–∫–∞—Ç–Ω–∏ –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ –∑–∞ —Ñ–∏–ª—Ç—Ä–∏
const grades = [...new Set(problems.map(p => p.grade))]
  .filter(g => g && g !== 'N/A')
  .sort((a, b) => parseInt(a) - parseInt(b));
const categories = [...new Set(problems.map(p => p.category))]
  .filter(c => c && c !== 'N/A')
  .sort();

const cleanBody = (text: string) => {
  if (!text) return "";
  return text
    .split('##')[0] // –ó–µ–º–∏ –≥–æ —Å–∞–º–æ —Ç–µ–∫—Å—Ç–æ—Ç –ø—Ä–µ–¥ –ø—Ä–≤–∏–æ—Ç –ø–æ–¥–Ω–∞—Å–ª–æ–≤
    .replace(/\[.*?\]\(.*?\)/g, '') // –ò–∑–±—Ä–∏—à–∏ –≥–∏ —Å–∏—Ç–µ Markdown –ª–∏–Ω–∫–æ–≤–∏
    .replace(/[\$\#\*\_]/g, '') // –ò–∑–±—Ä–∏—à–∏ –≥–∏ —Å–ø–µ—Ü–∏—ò–∞–ª–Ω–∏—Ç–µ Markdown –∑–Ω–∞—Ü–∏
    .replace(/\n/g, ' ') // –ü—Ä–µ—Ç–≤–æ—Ä–∏ –≥–∏ –Ω–æ–≤–∏—Ç–µ —Ä–µ–¥–æ–≤–∏ –≤–æ –ø—Ä–∞–∑–Ω–æ –º–µ—Å—Ç–æ
    .trim()
    .slice(0, 120) + '...';
};

const getDifficultyColor = (diff: number) => {
  if (diff <= 3) return 'bg-emerald-500';
  if (diff <= 7) return 'bg-amber-500';
  return 'bg-rose-500';
};
---

<Layout title="–ú–∞—Ç–ê—Ä—Ö–∏–≤–∞ | –î–∏–≥–∏—Ç–∞–ª–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞ –æ–ª–∏–º–ø–∏—ò—Ü–∏">
	{/* Hero Section */}
	<div class="relative mb-16 p-12 md:p-20 rounded-[3rem] bg-slate-950 overflow-hidden shadow-2xl border border-white/10 no-print">
		<div class="absolute top-0 right-0 w-full h-full opacity-20 pointer-events-none">
			<div class="absolute top-[-10%] right-[-10%] w-[50%] h-[50%] bg-blue-600 rounded-full blur-[120px]"></div>
			<div class="absolute bottom-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-600 rounded-full blur-[100px]"></div>
		</div>
		
		<div class="relative z-10 max-w-3xl">
			<div class="flex items-center gap-3 mb-8">
				<span class="inline-block px-4 py-1.5 rounded-full bg-blue-500/10 text-blue-400 text-xs font-black uppercase tracking-[0.2em] border border-blue-500/20 backdrop-blur-md">
					–î–∏–≥–∏—Ç–∞–ª–µ–Ω –¢—Ä–µ–∑–æ—Ä –∑–∞ –ó–Ω–∞–µ—ö–µ
				</span>
			</div>
			
			<h1 class="text-5xl md:text-7xl font-black text-white mb-8 leading-[1.1] tracking-tight">
				–ê—Ä—Ö–∏–≤–∞ –Ω–∞ <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400">–º–∞—Ç–µ–º–∞—Ç–∏—á–∫–∏</span> –ø—Ä–µ–¥–∏–∑–≤–∏—Ü–∏.
			</h1>
			
			<p class="text-slate-400 text-xl mb-10 leading-relaxed max-w-2xl font-medium">
				–°–µ–æ–ø—Ñ–∞—Ç–Ω–∞ –∑–±–∏—Ä–∫–∞ –Ω–∞ –æ–ª–∏–º–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á–∏ —Å–æ –≤—Ä–≤–Ω–∏ –≤–∏–∑—É–µ–ª–∏–∑–∞—Ü–∏–∏, –¥–µ—Ç–∞–ª–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏ –∏ –º–µ—Ç–æ–¥–∏—á–∫–∏ –Ω–∞—Å–æ–∫–∏.
			</p>
			
			<div class="flex flex-col sm:flex-row gap-4 max-w-2xl">
				<div class="relative flex-grow">
					<input 
						type="text" 
						id="search" 
						placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò –ø–æ –∏–º–µ, –æ–±–ª–∞—Å—Ç –∏–ª–∏ —Ç–µ–∫—Å—Ç..." 
						class="w-full pl-14 pr-4 py-5 bg-white/5 border border-white/10 rounded-2xl text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 outline-none backdrop-blur-xl transition-all shadow-2xl"
					/>
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500 absolute left-5 top-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
					</svg>
				</div>
			</div>
			
			<div class="mt-10 flex flex-wrap gap-6 items-center text-slate-500">
				<div class="flex items-center gap-2">
					<div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
					<span class="text-xs font-bold uppercase tracking-widest">{problems.length} –∑–∞–¥–∞—á–∏ –≤–æ –∞—Ä—Ö–∏–≤–∞—Ç–∞</span>
				</div>
				<div class="w-px h-4 bg-slate-800 hidden sm:block"></div>
				<div class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest">
					<span class="p-1 bg-slate-800 rounded">EXE</span>
					<span>–û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–æ –∑–∞ —É—á–µ—ö–µ</span>
				</div>
			</div>
		</div>
	</div>

	<div class="flex flex-col lg:flex-row gap-12">
		{/* Sidebar Filters */}
		<aside class="w-full lg:w-80 flex-shrink-0 space-y-8 no-print">
			<div class="sticky top-24">
				<div class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border border-slate-100 dark:border-slate-800 shadow-xl shadow-slate-200/50 dark:shadow-none transition-all hover:shadow-2xl">
					<div class="flex items-center justify-between mb-8">
						<h2 class="text-xl font-black flex items-center gap-3">
							<div class="w-2 h-6 bg-blue-600 rounded-full shadow-lg shadow-blue-500/50"></div>
							–§–∏–ª—Ç—Ä–∏—Ä–∞—ò
						</h2>
						<button id="reset-filters-top" class="text-[10px] font-black uppercase tracking-widest text-blue-600 hover:text-blue-700">–ò—Å—á–∏—Å—Ç–∏</button>
					</div>
					
					<div class="space-y-12">
						<div>
							<label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-5">–û–¥–¥–µ–ª–µ–Ω–∏–µ</label>
							<div class="grid grid-cols-3 gap-2" id="grade-filters">
								{grades.map(g => (
									<label class="cursor-pointer group">
										<input type="checkbox" value={g} class="hidden peer">
										<span class="w-full text-center px-2 py-3 rounded-xl border border-slate-100 dark:border-slate-800 text-xs font-bold bg-slate-50 dark:bg-slate-800 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 peer-checked:shadow-lg peer-checked:shadow-blue-500/30 transition-all inline-block group-hover:border-blue-200 dark:group-hover:border-slate-600">
											{g === 'N/A' ? '???' : g}
										</span>
									</label>
								))}
							</div>
						</div>

						<div>
							<label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-5">–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞</label>
							<div class="space-y-4" id="cat-filters">
								{categories.map(c => (
									<label class="flex items-center gap-4 cursor-pointer group">
										<input type="checkbox" value={c} class="hidden peer">
										<div class="w-6 h-6 rounded-lg border-2 border-slate-200 dark:border-slate-800 peer-checked:bg-blue-600 peer-checked:border-blue-600 transition-all flex items-center justify-center group-hover:border-blue-400">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white scale-0 peer-checked:scale-100 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7" />
											</svg>
										</div>
										<span class="text-sm font-bold text-slate-600 dark:text-slate-400 group-hover:text-slate-900 dark:group-hover:text-white capitalize transition-colors">{c}</span>
									</label>
								))}
							</div>
						</div>
					</div>
				</div>
			</div>
		</aside>

		{/* Grid */}
		<div class="flex-grow">
			<div class="mb-10 flex items-center justify-between no-print">
				<h2 class="text-2xl font-black text-slate-900 dark:text-white flex items-baseline gap-3">
					–ê—Ä—Ö–∏–≤–∞ 
					<span class="px-3 py-1 bg-slate-100 dark:bg-slate-800 text-slate-500 text-xs font-black rounded-full" id="count">{problems.length} –∑–∞–¥–∞—áa</span>
				</h2>
				
				<div class="flex items-center gap-2">
					<button class="p-2 text-slate-400 hover:text-blue-600 transition-colors" title="Grid View">
						<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
					</button>
				</div>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="problems-grid">
				{problems.map((prob) => (
					<div 
						class="problem-card group bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden hover:shadow-2xl hover:shadow-blue-500/10 hover:-translate-y-2 transition-all duration-500"
						data-grade={prob.grade}
						data-category={prob.category}
						data-title={prob.filename.toLowerCase().replace(/_/g, ' ')}
						data-search={cleanBody(prob.body).toLowerCase()}
					>
						<a href={`/tasks/${prob.meta.problem_id || prob.filename.replace('.md', '')}`} class="block h-full">
							<div class="aspect-[16/10] bg-slate-50 dark:bg-slate-950 flex items-center justify-center p-6 relative overflow-hidden">
								<div class="absolute inset-0 bg-gradient-to-br from-blue-600 to-indigo-600 opacity-0 group-hover:opacity-5 transition-opacity duration-500"></div>
								<img 
									src={`/assets/images/${prob.meta.problem_id || prob.filename.replace('.md', '')}/${prob.meta.problem_id || prob.filename.replace('.md', '')}.png`} 
									alt={prob.filename}
									class="max-w-full max-h-full object-contain relative z-10 transition-transform duration-700 group-hover:scale-110 drop-shadow-xl"
									onerror="this.src='https://via.placeholder.com/400x250?text=Geo-Mentor+–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞'"
								/>
								<div class={`absolute top-6 right-6 w-4 h-4 rounded-full ${getDifficultyColor(prob.difficulty)} shadow-lg border-2 border-white dark:border-slate-900 z-20`}></div>
							</div>
							<div class="p-8">
								<div class="flex items-center justify-between mb-4">
									<div class="flex gap-2">
										<span class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg border border-blue-100 dark:border-blue-900/50">
											{prob.grade} –û–¥–¥
										</span>
										<span class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 bg-slate-50 dark:bg-slate-800 text-slate-500 rounded-lg border border-slate-100 dark:border-slate-800 capitalize">
											{prob.category}
										</span>
									</div>
								</div>
								<h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4 leading-tight group-hover:text-blue-600 transition-colors line-clamp-2">
									{prob.filename.replace('.md', '').replace(/_/g, ' ')}
								</h3>
								<p class="text-slate-500 dark:text-slate-400 text-sm leading-relaxed mb-8 line-clamp-3 font-medium">
									{cleanBody(prob.body)}
								</p>
								<div class="flex items-center justify-between">
									<div class="text-xs font-black uppercase tracking-tighter text-blue-600 flex items-center gap-2 group-hover:gap-4 transition-all">
										–í–∏–¥–∏ –ó–∞–¥–∞—á–∞ <span>‚Üí</span>
									</div>
									<div class="flex -space-x-2">
										{[...Array(3)].map(() => (
											<div class="w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-800 border-2 border-white dark:border-slate-900 flex items-center justify-center">
												<div class="w-2 h-2 rounded-full bg-slate-300 dark:bg-slate-600"></div>
											</div>
										))}
									</div>
								</div>
							</div>
						</a>
					</div>
				))}
			</div>
			
			<div id="no-results" class="hidden py-40 text-center bg-white dark:bg-slate-900 rounded-[3rem] border border-dashed border-slate-200 dark:border-slate-800">
				<div class="text-8xl mb-6 grayscale opacity-20">üîç</div>
				<h3 class="text-2xl font-black text-slate-900 dark:text-white mb-2">–ù–µ–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</h3>
				<p class="text-slate-500">–ü—Ä–æ–±–∞—ò—Ç–µ —Å–æ –ø–æ–∏–Ω–∞–∫–≤–∏ —Ñ–∏–ª—Ç—Ä–∏ –∏–ª–∏ –ø—Ä–µ–±–∞—Ä—É–≤–∞—ö–µ.</p>
			</div>
		</div>
	</div>
</Layout>

<script>
	import Fuse from 'fuse.js';

	const searchInput = document.getElementById('search') as HTMLInputElement;
	const cards = document.querySelectorAll('.problem-card') as NodeListOf<HTMLElement>;
	const countEl = document.getElementById('count');
	const noResults = document.getElementById('no-results');
	const gradeFilters = document.querySelectorAll('#grade-filters input') as NodeListOf<HTMLInputElement>;
	const catFilters = document.querySelectorAll('#cat-filters input') as NodeListOf<HTMLInputElement>;
	const resetBtn = document.getElementById('reset-filters');
	const resetBtnTop = document.getElementById('reset-filters-top');

	// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ –ø–æ–¥–∞—Ç–æ—Ü–∏ –∑–∞ Fuse.js
	const searchData = Array.from(cards).map(card => ({
		id: card.dataset.title,
		title: card.dataset.title,
		body: card.dataset.search,
		element: card
	}));

	const fuse = new Fuse(searchData, {
		keys: ['title', 'body'],
		threshold: 0.3,
		distance: 100
	});

	function filter() {
		const query = searchInput.value.toLowerCase();
		const selectedGrades = Array.from(gradeFilters).filter(i => i.checked).map(i => i.value);
		const selectedCats = Array.from(catFilters).filter(i => i.checked).map(i => i.value);

		let visibleCount = 0;
		
		// –†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ–¥ Fuzzy Search
		const fuseResults = query ? fuse.search(query).map(r => r.item.element) : null;

		cards.forEach(card => {
			const grade = card.dataset.grade || '';
			const cat = card.dataset.category || '';

			const matchesSearch = !fuseResults || fuseResults.includes(card);
			const matchesGrade = selectedGrades.length === 0 || selectedGrades.includes(grade);
			const matchesCat = selectedCats.length === 0 || selectedCats.includes(cat);

			if (matchesSearch && matchesGrade && matchesCat) {
				card.style.display = 'block';
				visibleCount++;
			} else {
				card.style.display = 'none';
			}
		});

		// –ê–∂—É—Ä–∏—Ä–∞—ò –≥–æ –±—Ä–æ—ò–∞—á–æ—Ç —Å–æ –ø—Ä–∞–≤–∏–ª–Ω–∞ –º–Ω–æ–∂–∏–Ω–∞
		if (countEl) {
			const text = visibleCount === 1 ? '–∑–∞–¥–∞—á–∞' : '–∑–∞–¥–∞—á–∏';
			countEl.textContent = `${visibleCount} ${text}`;
		}
		if (noResults) noResults.style.display = visibleCount === 0 ? 'block' : 'none';
	}

	searchInput?.addEventListener('input', filter);
	gradeFilters.forEach(i => i.addEventListener('change', filter));
	catFilters.forEach(i => i.addEventListener('change', filter));
	
	const resetAll = () => {
		gradeFilters.forEach(i => i.checked = false);
		catFilters.forEach(i => i.checked = false);
		searchInput.value = '';
		filter();
	};

	resetBtn?.addEventListener('click', resetAll);
	resetBtnTop?.addEventListener('click', resetAll);
</script>
