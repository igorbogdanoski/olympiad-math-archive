---
import Layout from '../layouts/Layout.astro';
import problems from '../data/problems.json';

// –ï–∫—Å—Ç—Ä–∞–∫—Ü–∏—ò–∞ –Ω–∞ —É–Ω–∏–∫–∞—Ç–Ω–∏ –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ –∑–∞ —Ñ–∏–ª—Ç—Ä–∏
const grades = [...new Set(problems.map(p => p.grade))]
  .filter(g => g && g !== 'N/A')
  .sort((a, b) => parseInt(a) - parseInt(b));
const categories = [...new Set(problems.map(p => p.category))]
  .filter(c => c && c !== 'N/A')
  .sort();

const cleanBody = (text: string) => {
  if (!text) return "";
  return text
    .split('##')[0] // –ó–µ–º–∏ –≥–æ —Å–∞–º–æ —Ç–µ–∫—Å—Ç–æ—Ç –ø—Ä–µ–¥ –ø—Ä–≤–∏–æ—Ç –ø–æ–¥–Ω–∞—Å–ª–æ–≤
    .replace(/\[.*?\]\(.*?\)/g, '') // –ò–∑–±—Ä–∏—à–∏ –≥–∏ —Å–∏—Ç–µ Markdown –ª–∏–Ω–∫–æ–≤–∏
    .replace(/[\$\#\*\_]/g, '') // –ò–∑–±—Ä–∏—à–∏ –≥–∏ —Å–ø–µ—Ü–∏—ò–∞–ª–Ω–∏—Ç–µ Markdown –∑–Ω–∞—Ü–∏
    .replace(/\n/g, ' ') // –ü—Ä–µ—Ç–≤–æ—Ä–∏ –≥–∏ –Ω–æ–≤–∏—Ç–µ —Ä–µ–¥–æ–≤–∏ –≤–æ –ø—Ä–∞–∑–Ω–æ –º–µ—Å—Ç–æ
    .trim()
    .slice(0, 120) + '...';
};

const getDifficultyColor = (diff: number) => {
  if (diff <= 3) return 'bg-emerald-500';
  if (diff <= 7) return 'bg-amber-500';
  return 'bg-rose-500';
};
---

<Layout title="–ú–∞—Ç–ê—Ä—Ö–∏–≤–∞ | –î–∏–≥–∏—Ç–∞–ª–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞ –æ–ª–∏–º–ø–∏—ò—Ü–∏">
	{/* Hero Section */}
	<div class="relative mb-16 p-12 rounded-[3rem] bg-slate-900 overflow-hidden shadow-2xl">
		<div class="absolute top-0 right-0 w-1/2 h-full opacity-10 pointer-events-none">
			<svg viewBox="0 0 100 100" class="w-full h-full fill-white">
				<path d="M0,50 Q25,0 50,50 T100,50 L100,100 L0,100 Z" />
			</svg>
		</div>
		<div class="relative z-10 max-w-2xl">
			<span class="inline-block px-4 py-1 rounded-full bg-blue-500/20 text-blue-400 text-xs font-bold uppercase tracking-widest mb-6 border border-blue-500/30">
				–î–æ–±—Ä–µ–¥–æ—ò–¥–æ–≤—Ç–µ –≤–æ Geo-Mentor
			</span>
			<h1 class="text-4xl md:text-6xl font-black text-white mb-6 leading-tight">
				–ò—Å—Ç—Ä–∞–∂–∏ –≥–æ —Å–≤–µ—Ç–æ—Ç –Ω–∞ <span class="text-blue-500">–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞—Ç–∞.</span>
			</h1>
			<p class="text-slate-400 text-lg mb-8 leading-relaxed">
				–ü—Ä–æ–Ω–∞—ò–¥–µ—Ç–µ –≥–∏ –Ω–∞—ò–¥–æ–±—Ä–∏—Ç–µ –æ–ª–∏–º–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á–∏, –¥–µ—Ç–∞–ª–Ω–∏ —Ä–µ—à–µ–Ω–∏—ò–∞ –∏ –≤–∏–∑—É–µ–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞ –µ–¥–Ω–æ –º–µ—Å—Ç–æ.
			</p>
			<div class="relative max-w-md">
				<input 
					type="text" 
					id="search" 
					placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò –ø–æ –∏–º–µ, –æ–±–ª–∞—Å—Ç –∏–ª–∏ —Ç–µ–∫—Å—Ç..." 
					class="w-full pl-12 pr-4 py-4 bg-white/10 border border-white/10 rounded-2xl text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 outline-none backdrop-blur-md transition-all"
				/>
				<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500 absolute left-4 top-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
			</div>
		</div>
	</div>

	<div class="flex flex-col lg:flex-row gap-12">
		{/* Sidebar Filters */}
		<aside class="w-full lg:w-72 flex-shrink-0 space-y-8">
			<div class="sticky top-24">
				<div class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border border-slate-100 dark:border-slate-800 shadow-sm">
					<h2 class="text-xl font-bold mb-8 flex items-center gap-3">
						<div class="w-2 h-6 bg-blue-600 rounded-full"></div>
						–§–∏–ª—Ç—Ä–∏—Ä–∞—ò
					</h2>
					
					<div class="space-y-10">
						<div>
							<label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">–û–¥–¥–µ–ª–µ–Ω–∏–µ</label>
							<div class="flex flex-wrap gap-2" id="grade-filters">
								{grades.map(g => (
									<label class="cursor-pointer group">
										<input type="checkbox" value={g} class="hidden peer">
										<span class="px-4 py-2 rounded-xl border border-slate-100 dark:border-slate-800 text-sm font-bold bg-slate-50 dark:bg-slate-800 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all inline-block group-hover:border-blue-200">
											{g === 'N/A' ? '???' : g}
										</span>
									</label>
								))}
							</div>
						</div>

						<div>
							<label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞</label>
							<div class="space-y-3" id="cat-filters">
								{categories.map(c => (
									<label class="flex items-center gap-3 cursor-pointer group">
										<input type="checkbox" value={c} class="hidden peer">
										<div class="w-5 h-5 rounded-md border-2 border-slate-200 dark:border-slate-700 peer-checked:bg-blue-600 peer-checked:border-blue-600 transition-all flex items-center justify-center">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white scale-0 peer-checked:scale-100 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7" />
											</svg>
										</div>
										<span class="text-sm font-bold text-slate-600 dark:text-slate-400 group-hover:text-slate-900 dark:group-hover:text-white capitalize">{c}</span>
									</label>
								))}
							</div>
						</div>

						<button id="reset-filters" class="w-full py-4 text-xs font-black uppercase tracking-widest text-slate-400 hover:text-blue-600 transition-colors">
							–ò—Å—á–∏—Å—Ç–∏ —Å√®
						</button>
					</div>
				</div>
			</div>
		</aside>

		{/* Grid */}
		<div class="flex-grow">
			<div class="mb-10 flex items-center justify-between">
				<h2 class="text-2xl font-black text-slate-900 dark:text-white">–ê—Ä—Ö–∏–≤–∞ <span class="text-slate-400 ml-2 text-sm font-bold" id="count">{problems.length} –∑–∞–¥–∞—áa</span></h2>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="problems-grid">
				{problems.map((prob) => (
					<div 
						class="problem-card group bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden hover:shadow-2xl hover:-translate-y-2 transition-all duration-500"
						data-grade={prob.grade}
						data-category={prob.category}
						data-title={prob.filename.toLowerCase().replace(/_/g, ' ')}
						data-search={cleanBody(prob.body).toLowerCase()}
					>
						<a href={`/tasks/${prob.meta.problem_id || prob.filename.replace('.md', '')}`} class="block h-full">
							<div class="aspect-[16/10] bg-slate-50 dark:bg-slate-950 flex items-center justify-center p-6 relative overflow-hidden">
								<div class="absolute inset-0 bg-blue-600 opacity-0 group-hover:opacity-5 transition-opacity duration-500"></div>
								<img 
									src={`/assets/images/${prob.meta.problem_id || prob.filename.replace('.md', '')}/${prob.meta.problem_id || prob.filename.replace('.md', '')}.png`} 
									alt={prob.filename}
									class="max-w-full max-h-full object-contain relative z-10 transition-transform duration-700 group-hover:scale-110"
									onerror="this.src='https://via.placeholder.com/400x250?text=Geo-Mentor+–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞'"
								/>
								<div class={`absolute top-6 right-6 w-3 h-3 rounded-full ${getDifficultyColor(prob.difficulty)} shadow-lg`}></div>
							</div>
							<div class="p-8">
								<div class="flex gap-2 mb-4">
									<span class="text-[9px] font-black uppercase tracking-widest px-3 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg border border-blue-100 dark:border-blue-900/50">
										{prob.grade} –û–¥–¥
									</span>
									<span class="text-[9px] font-black uppercase tracking-widest px-3 py-1 bg-slate-50 dark:bg-slate-800 text-slate-500 rounded-lg border border-slate-100 dark:border-slate-800 capitalize">
										{prob.category}
									</span>
								</div>
								<h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4 leading-tight group-hover:text-blue-600 transition-colors">
									{prob.filename.replace('.md', '').replace(/_/g, ' ')}
								</h3>
								<p class="text-slate-500 dark:text-slate-400 text-sm leading-relaxed mb-6">
									{cleanBody(prob.body)}
								</p>
								<div class="pt-6 border-t border-slate-50 dark:border-slate-800 flex items-center text-xs font-black uppercase tracking-tighter text-blue-600">
									–í–∏–¥–∏ –ó–∞–¥–∞—á–∞ <span class="ml-2 transition-transform group-hover:translate-x-2">‚Üí</span>
								</div>
							</div>
						</a>
					</div>
				))}
			</div>
			
			<div id="no-results" class="hidden py-40 text-center bg-white dark:bg-slate-900 rounded-[3rem] border border-dashed border-slate-200 dark:border-slate-800">
				<div class="text-8xl mb-6 grayscale opacity-20">üîç</div>
				<h3 class="text-2xl font-black text-slate-900 dark:text-white mb-2">–ù–µ–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</h3>
				<p class="text-slate-500">–ü—Ä–æ–±–∞—ò—Ç–µ —Å–æ –ø–æ–∏–Ω–∞–∫–≤–∏ —Ñ–∏–ª—Ç—Ä–∏ –∏–ª–∏ –ø—Ä–µ–±–∞—Ä—É–≤–∞—ö–µ.</p>
			</div>
		</div>
	</div>
</Layout>

<script>
	import Fuse from 'fuse.js';

	const searchInput = document.getElementById('search') as HTMLInputElement;
	const cards = document.querySelectorAll('.problem-card') as NodeListOf<HTMLElement>;
	const countEl = document.getElementById('count');
	const noResults = document.getElementById('no-results');
	const gradeFilters = document.querySelectorAll('#grade-filters input') as NodeListOf<HTMLInputElement>;
	const catFilters = document.querySelectorAll('#cat-filters input') as NodeListOf<HTMLInputElement>;
	const resetBtn = document.getElementById('reset-filters');

	// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ –ø–æ–¥–∞—Ç–æ—Ü–∏ –∑–∞ Fuse.js
	const searchData = Array.from(cards).map(card => ({
		id: card.dataset.title,
		title: card.dataset.title,
		body: card.dataset.search,
		element: card
	}));

	const fuse = new Fuse(searchData, {
		keys: ['title', 'body'],
		threshold: 0.3,
		distance: 100
	});

	function filter() {
		const query = searchInput.value.toLowerCase();
		const selectedGrades = Array.from(gradeFilters).filter(i => i.checked).map(i => i.value);
		const selectedCats = Array.from(catFilters).filter(i => i.checked).map(i => i.value);

		let visibleCount = 0;
		
		// –†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ–¥ Fuzzy Search
		const fuseResults = query ? fuse.search(query).map(r => r.item.element) : null;

		cards.forEach(card => {
			const grade = card.dataset.grade || '';
			const cat = card.dataset.category || '';

			const matchesSearch = !fuseResults || fuseResults.includes(card);
			const matchesGrade = selectedGrades.length === 0 || selectedGrades.includes(grade);
			const matchesCat = selectedCats.length === 0 || selectedCats.includes(cat);

			if (matchesSearch && matchesGrade && matchesCat) {
				card.style.display = 'block';
				visibleCount++;
			} else {
				card.style.display = 'none';
			}
		});

		// –ê–∂—É—Ä–∏—Ä–∞—ò –≥–æ –±—Ä–æ—ò–∞—á–æ—Ç —Å–æ –ø—Ä–∞–≤–∏–ª–Ω–∞ –º–Ω–æ–∂–∏–Ω–∞
		if (countEl) {
			const text = visibleCount === 1 ? '–∑–∞–¥–∞—á–∞' : '–∑–∞–¥–∞—á–∏';
			countEl.textContent = `${visibleCount} ${text}`;
		}
		if (noResults) noResults.style.display = visibleCount === 0 ? 'block' : 'none';
	}

	searchInput?.addEventListener('input', filter);
	gradeFilters.forEach(i => i.addEventListener('change', filter));
	catFilters.forEach(i => i.addEventListener('change', filter));
	
	resetBtn?.addEventListener('click', () => {
		gradeFilters.forEach(i => i.checked = false);
		catFilters.forEach(i => i.checked = false);
		searchInput.value = '';
		filter();
	});
</script>
